<!DOCTYPE html>
<html>
<head>
  <title>postgresql.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "src/driver/postgresql.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#postgresql-access">PostgreSQL access</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#setup">Setup</a>
      </div>

      <div class="heading h1">
        <a href="#remember-all-values-returned-from-the-server-are-either-null-or-a-string">remember: all values returned from the server are either NULL or a string</a>
      </div>

      <div class="heading h2">
        <a href="#database-class">Database class</a>
      </div>

      <div class="heading h2">
        <a href="#connection-handling">Connection handling</a>
      </div>

      <div class="heading h3">
        <a href="#create-instance">Create instance</a>
      </div>

      <div class="heading h3">
        <a href="#get-connection">Get connection</a>
      </div>

      <div class="heading h2">
        <a href="#shortcut-functions">Shortcut functions</a>
      </div>

      <div class="heading h3">
        <a href="#update-insert-or-delete-something-and-return-count-of-changes">update, insert or delete something and return count of changes</a>
      </div>

      <div class="heading h3">
        <a href="#get-all-data-as-object">get all data as object</a>
      </div>

      <div class="heading h3">
        <a href="#get-one-record-as-object">get one record as object</a>
      </div>

      <div class="heading h3">
        <a href="#get-value-of-one-field">get value of one field</a>
      </div>

      <div class="heading h3">
        <a href="#get-value-of-one-field-1">get value of one field</a>
      </div>

      <div class="heading h2">
        <a href="#query-helper">Query helper</a>
      </div>

      <div class="heading h3">
        <a href="#prepare-parameter">prepare parameter</a>
      </div>

      <div class="heading h3">
        <a href="#run-the-query-on-the-wrapped-driver">Run the query on the wrapped driver</a>
      </div>

      <div class="heading h2">
        <a href="#query-creation">Query creation</a>
      </div>

      <div class="heading h2">
        <a href="#exports">Exports</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-database" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="postgresql-access">
  <h1>
    <a href="#postgresql-access" name="postgresql-access" class="pilcrow"></a>
PostgreSQL access
  </h1>
</div>
<p>This package will give you an easy and robust way to access PostgreSQL databases.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debugPool = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:pool'</span>)
debugCmd = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:cmd'</span>)
debugResult = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:result'</span>)
debugData = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:data'</span>)
debugCom = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:com'</span>)
debugError = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:error'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
pg = <span class="hljs-built_in">require</span> <span class="hljs-string">'pg'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>require alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">util = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>loading helper modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">object2sql = <span class="hljs-built_in">require</span> <span class="hljs-string">'../object2sql'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="setup">
  <h2>
    <a href="#setup" name="setup" class="pilcrow"></a>
Setup
  </h2>
</div>
<p>Return int8 values as integer -&gt; maybe problematic on large values because
javascript can't handle this.
pg.setTypeParser 20, (val) -&gt;</p>
<div class="pilwrap" id="remember-all-values-returned-from-the-server-are-either-null-or-a-string">
  <h1>
    <a href="#remember-all-values-returned-from-the-server-are-either-null-or-a-string" name="remember-all-values-returned-from-the-server-are-either-null-or-a-string" class="pilcrow"></a>
remember: all values returned from the server are either NULL or a string
  </h1>
</div>
<p>return val === null ? null : parseInt val</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="database-class">
  <h2>
    <a href="#database-class" name="database-class" class="pilcrow"></a>
Database class
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Postgresql</span></span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="connection-handling">
  <h2>
    <a href="#connection-handling" name="connection-handling" class="pilcrow"></a>
Connection handling
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="create-instance">
  <h3>
    <a href="#create-instance" name="create-instance" class="pilcrow"></a>
Create instance
  </h3>
</div>
<p>This will also load the data if not already done. Don't call this directly
better use the <code>instance()</code> method which implements the factory pattern.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  constructor: <span class="hljs-function"><span class="hljs-params">(@name, @conf)</span> -&gt;</span>
    @tries = <span class="hljs-number">0</span>
    @connectionNum = <span class="hljs-number">0</span>
    pg.defaults.poolSize = @conf.pool?.limit

  close: <span class="hljs-function"><span class="hljs-params">(cb = -&gt; )</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> @pool?
    debugPool <span class="hljs-string">"close connection pool for <span class="hljs-subst">#{@name}</span>"</span>
    @pool.end (err) =&gt;</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>remove pool instance to be reopened on next use</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      @pool = <span class="hljs-literal">null</span>
      cb err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-connection">
  <h3>
    <a href="#get-connection" name="get-connection" class="pilcrow"></a>
Get connection
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  connect: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    setup = util.extend
      application_name: process.title
      fallback_application_name: <span class="hljs-string">'alinex-database'</span>
    , @conf.access</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>console.log 'client', util.inspect client, {depth:null}</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    pool = pg.pools.getOrCreate setup
    debugPool <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey @name}</span> retrieve connection"</span> +
      chalk.grey <span class="hljs-string">" (pool <span class="hljs-subst">#{pool.availableObjectsCount()}</span>/<span class="hljs-subst">#{pool.getPoolSize()}</span>)"</span>
    pg.connect setup, <span class="hljs-function"><span class="hljs-params">(err, conn, done)</span> =&gt;</span>
      <span class="hljs-keyword">if</span> err
        done err
        debugError <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> error <span class="hljs-subst">#{err.message}</span>"</span>
        err.message += <span class="hljs-string">" at <span class="hljs-subst">#{@name}</span>"</span>
        <span class="hljs-keyword">return</span> cb err
      <span class="hljs-keyword">if</span> conn.alinex?
        debugPool <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> reuse connection"</span> +
          chalk.grey <span class="hljs-string">" (pool <span class="hljs-subst">#{pool.availableObjectsCount()}</span>/<span class="hljs-subst">#{pool.getPoolSize()}</span>)"</span>
        <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, conn
      conn.name = chalk.grey <span class="hljs-string">"[<span class="hljs-subst">#{@name}</span>#<span class="hljs-subst">#{++@connectionNum}</span>]"</span> <span class="hljs-keyword">unless</span> conn.name?
      debugPool <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> opened new connection"</span> +
        chalk.grey <span class="hljs-string">" (pool <span class="hljs-subst">#{pool.availableObjectsCount()}</span>/<span class="hljs-subst">#{pool.getPoolSize()}</span>)"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>add debugging</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      conn.release = <span class="hljs-function">-&gt;</span>
        done()
        debugPool <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> release connection"</span> +
          chalk.grey <span class="hljs-string">" (pool <span class="hljs-subst">#{pool.availableObjectsCount()}</span>/<span class="hljs-subst">#{pool.getPoolSize()}</span>)"</span>
      conn.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
        done err
        debugError <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> failure <span class="hljs-subst">#{err.message}</span>"</span>
      query = conn.query
      conn.query = <span class="hljs-function"><span class="hljs-params">(sql, data, cb)</span> -&gt;</span>
        <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> cb <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
          cb = data
          data = <span class="hljs-literal">null</span>
        data = [data] <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> data <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
        debugCmd <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{sql}</span><span class="hljs-subst">#{
          <span class="hljs-keyword">if</span> data <span class="hljs-keyword">then</span> chalk.grey(<span class="hljs-string">' with '</span>) + util.inspect(data).replace <span class="hljs-regexp">/\s+/g</span>, <span class="hljs-string">' '</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>
          }</span>"</span>
        <span class="hljs-keyword">if</span> cb
          query.apply conn, [sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> err
              debugError <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{chalk.grey err.message}</span>"</span>
            <span class="hljs-keyword">if</span> result?
              <span class="hljs-keyword">if</span> result.fields.length
                debugResult <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> fields: <span class="hljs-subst">#{util.inspect result.fields}</span>"</span>
              <span class="hljs-keyword">if</span> result.rows.length
                debugData <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{util.inspect row}</span>"</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result.rows</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<pre><code>         console.log result
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">            cb err, result
          ]
          conn.alinex = <span class="hljs-literal">true</span>
          <span class="hljs-keyword">return</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>called using events</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        fn = query.apply conn, [sql, data]
        <span class="hljs-keyword">if</span> debugCmd.enabled <span class="hljs-keyword">or</span> debugData.enabled <span class="hljs-keyword">or</span> debugResult.enabled <span class="hljs-keyword">or</span> debugError.enabled
          fn.<span class="hljs-literal">on</span>? <span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-params">(row)</span> -&gt;</span>
            debugData <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{row}</span>"</span>
          fn.<span class="hljs-literal">on</span>? <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
            debugError <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{chalk.red.bold err.message}</span>"</span>
          fn.<span class="hljs-literal">on</span>? <span class="hljs-string">'end'</span>, <span class="hljs-function">-&gt;</span>
            debugCom chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> end query"</span>
        fn
        <span class="hljs-keyword">if</span> debugCom.enabled
          conn.<span class="hljs-literal">on</span> <span class="hljs-string">'drain'</span>, <span class="hljs-function">-&gt;</span>
            debugCom chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> drained"</span>
          conn.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
            debugCom chalk.magenta <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> error: <span class="hljs-subst">#{err.message}</span>"</span>
          conn.<span class="hljs-literal">on</span> <span class="hljs-string">'notice'</span>, <span class="hljs-function"><span class="hljs-params">(msg)</span> -&gt;</span>
            debugCom chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> notice: <span class="hljs-subst">#{msg}</span>"</span>
        conn.alinex = <span class="hljs-literal">true</span>
      cb <span class="hljs-literal">null</span>, conn</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="shortcut-functions">
  <h2>
    <a href="#shortcut-functions" name="shortcut-functions" class="pilcrow"></a>
Shortcut functions
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="update-insert-or-delete-something-and-return-count-of-changes">
  <h3>
    <a href="#update-insert-or-delete-something-and-return-count-of-changes" name="update-insert-or-delete-something-and-return-count-of-changes" class="pilcrow"></a>
update, insert or delete something and return count of changes
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  exec: <span class="hljs-function">-&gt;</span> @prepare arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @query conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      match = sql.match <span class="hljs-regexp">/\sRETURNING\s+(\S+)/</span>
      lastId = result.rows[<span class="hljs-number">0</span>]?[match[<span class="hljs-number">1</span>]] <span class="hljs-keyword">if</span> match?[<span class="hljs-number">1</span>]?
      cb err, result.rowCount, lastId</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-all-data-as-object">
  <h3>
    <a href="#get-all-data-as-object" name="get-all-data-as-object" class="pilcrow"></a>
get all data as object
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  list: <span class="hljs-function">-&gt;</span> @prepare arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @query conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      cb err, result?.rows</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-one-record-as-object">
  <h3>
    <a href="#get-one-record-as-object" name="get-one-record-as-object" class="pilcrow"></a>
get one record as object
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  record: <span class="hljs-function">-&gt;</span> @prepare arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>get only one row</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> sql <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
      sql.limit = <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">unless</span> sql.match <span class="hljs-regexp">/\slimit\s+\d/i</span>
      sql += <span class="hljs-string">" LIMIT 1"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @query conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      rows = result.rows
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> rows.length</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>parse result</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      cb err, rows[<span class="hljs-number">0</span>]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-value-of-one-field">
  <h3>
    <a href="#get-value-of-one-field" name="get-value-of-one-field" class="pilcrow"></a>
get value of one field
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  value: <span class="hljs-function">-&gt;</span> @prepare arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>get only one row</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> sql <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
      sql.limit = <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">unless</span> sql.match <span class="hljs-regexp">/\slimit\s+\d/i</span>
      sql += <span class="hljs-string">" LIMIT 1"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @query conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      rows = result.rows
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> rows.length</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>parse result</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      cb err, rows[<span class="hljs-number">0</span>][Object.keys(rows[<span class="hljs-number">0</span>])[<span class="hljs-number">0</span>]]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-value-of-one-field-1">
  <h3>
    <a href="#get-value-of-one-field-1" name="get-value-of-one-field-1" class="pilcrow"></a>
get value of one field
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  column: <span class="hljs-function">-&gt;</span> @prepare arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @query conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      rows = result.rows
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> rows.length</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>parse result</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      cb err, rows.map (e) -&gt; e[Object.keys(e)[<span class="hljs-number">0</span>]]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="query-helper">
  <h2>
    <a href="#query-helper" name="query-helper" class="pilcrow"></a>
Query helper
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="prepare-parameter">
  <h3>
    <a href="#prepare-parameter" name="prepare-parameter" class="pilcrow"></a>
prepare parameter
  </h3>
</div>
<p>This will also open a self closing connection if none given.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  prepare: <span class="hljs-function"><span class="hljs-params">(args, cb)</span> -&gt;</span>
    args = Array.prototype.slice.call args</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>defaultd</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    conn = <span class="hljs-literal">null</span>
<span class="hljs-function">    <span class="hljs-title">done</span> = -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> args[<span class="hljs-number">0</span>].constructor.name <span class="hljs-keyword">isnt</span> <span class="hljs-string">'Object'</span>
      conn = args.shift()
    last = args.length - <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> args[last] <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      done = args.pop()
    [sql, data] = args
    <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, conn, sql, data, done <span class="hljs-keyword">if</span> conn
    @connect (err, conn) -&gt;
      cb err, conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
        conn.release()
        <span class="hljs-keyword">return</span> done <span class="hljs-keyword">new</span> Error <span class="hljs-string">"PostgreSQL Error: <span class="hljs-subst">#{err.message}</span>"</span> <span class="hljs-keyword">if</span> err
        done.apply <span class="hljs-keyword">this</span>, arguments</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-the-query-on-the-wrapped-driver">
  <h3>
    <a href="#run-the-query-on-the-wrapped-driver" name="run-the-query-on-the-wrapped-driver" class="pilcrow"></a>
Run the query on the wrapped driver
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  query: <span class="hljs-function"><span class="hljs-params">(conn, sql, data, cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>replace placeholder and interpret object structure</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    sql = @sql sql, data</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    conn.query sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"PostgreSQL Error: <span class="hljs-subst">#{err.message}</span> in <span class="hljs-subst">#{sql}</span>"</span> <span class="hljs-keyword">if</span> err
      cb <span class="hljs-literal">null</span>, result</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="query-creation">
  <h2>
    <a href="#query-creation" name="query-creation" class="pilcrow"></a>
Query creation
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  escape: <span class="hljs-function">-&gt;</span><span class="hljs-comment">#SqlString.escape</span>
  escapeId: <span class="hljs-function">-&gt;</span><span class="hljs-comment">#SqlString.escapeId</span>

  sql: <span class="hljs-function"><span class="hljs-params">(sql)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> sql <span class="hljs-keyword">isnt</span> <span class="hljs-string">'string'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>object syntax</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      sql = object2sql sql, <span class="hljs-keyword">this</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>if sql.match /?(?=([^']<em>'[^']</em>')<em>[^']</em>$)/
replace ? with $1...</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    num = <span class="hljs-number">0</span>
    sql.replace <span class="hljs-regexp">/\?(?=([^']*'[^']*')*[^']*$)/g</span>, <span class="hljs-function">-&gt;</span> <span class="hljs-string">"$<span class="hljs-subst">#{++num}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="exports">
  <h2>
    <a href="#exports" name="exports" class="pilcrow"></a>
Exports
  </h2>
</div>
<p>The postgresql class is exported directly.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports = Postgresql</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
