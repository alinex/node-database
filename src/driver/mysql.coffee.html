<!DOCTYPE html>
<html>
<head>
  <title>mysql.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "home/alex/github/node-database/src/driver/mysql.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#mysql-access">Mysql access</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#database-class">Database class</a>
      </div>

      <div class="heading h2">
        <a href="#connection-handling">Connection handling</a>
      </div>

      <div class="heading h3">
        <a href="#create-instance">Create instance</a>
      </div>

      <div class="heading h3">
        <a href="#get-connection">Get connection</a>
      </div>

      <div class="heading h2">
        <a href="#shortcut-functions">Shortcut functions</a>
      </div>

      <div class="heading h3">
        <a href="#update-insert-or-delete-something-and-return-count-of-changes">update, insert or delete something and return count of changes</a>
      </div>

      <div class="heading h3">
        <a href="#get-all-data-as-object">get all data as object</a>
      </div>

      <div class="heading h3">
        <a href="#get-one-record-as-object">get one record as object</a>
      </div>

      <div class="heading h3">
        <a href="#get-value-of-one-field">get value of one field</a>
      </div>

      <div class="heading h3">
        <a href="#get-value-of-one-field-1">get value of one field</a>
      </div>

      <div class="heading h2">
        <a href="#query-helper">Query helper</a>
      </div>

      <div class="heading h3">
        <a href="#prepare-parameter">prepare parameter</a>
      </div>

      <div class="heading h3">
        <a href="#run-the-query-on-the-wrapped-driver">Run the query on the wrapped driver</a>
      </div>

      <div class="heading h2">
        <a href="#query-creation">Query creation</a>
      </div>

      <div class="heading h3">
        <a href="#replace-placeholder-and-object-structure">Replace placeholder and object structure</a>
      </div>

      <div class="heading h2">
        <a href="#exports">Exports</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-database" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="mysql-access">
  <h1>
    <a href="#mysql-access" name="mysql-access" class="pilcrow"></a>
Mysql access
  </h1>
</div>
<p>This package will give you an easy and robust way to access mysql databases.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules
debug = require('debug')('db:mysql')</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debugPool = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:pool'</span>)
debugCmd = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:cmd'</span>)
debugResult = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:result'</span>)
debugData = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:data'</span>)
debugCom = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:com'</span>)
debugError = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database:error'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
mysql = <span class="hljs-built_in">require</span> <span class="hljs-string">'mysql'</span>
SqlString = <span class="hljs-built_in">require</span> <span class="hljs-string">'mysql/lib/protocol/SqlString'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>require alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">{object} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>loading helper modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">object2sql = <span class="hljs-built_in">require</span> <span class="hljs-string">'../object2sql'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="database-class">
  <h2>
    <a href="#database-class" name="database-class" class="pilcrow"></a>
Database class
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mysql</span></span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="connection-handling">
  <h2>
    <a href="#connection-handling" name="connection-handling" class="pilcrow"></a>
Connection handling
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="create-instance">
  <h3>
    <a href="#create-instance" name="create-instance" class="pilcrow"></a>
Create instance
  </h3>
</div>
<p>This will also load the data if not already done. Don't call this directly
better use the <code>instance()</code> method which implements the factory pattern.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@name</span>, <span class="hljs-property">@conf</span>)</span> -&gt;</span>
    <span class="hljs-property">@tries</span> = <span class="hljs-number">0</span>

  <span class="hljs-attribute">close</span>: <span class="hljs-function"><span class="hljs-params">(cb = -&gt; )</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> <span class="hljs-property">@pool</span>?
    debugPool <span class="hljs-string">"close connection pool for <span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>"</span>
    <span class="hljs-property">@pool</span>.end (err) =&gt;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>remove pool instance to be reopened on next use</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-property">@pool</span> = <span class="hljs-literal">null</span>
      cb err

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-connection">
  <h3>
    <a href="#get-connection" name="get-connection" class="pilcrow"></a>
Get connection
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">connect</span>: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>instantiate pool if not already done</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">unless</span> <span class="hljs-property">@pool</span>?
      debugPool <span class="hljs-string">"initialize connection pool for <span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>"</span>
      setup = object.extend
        <span class="hljs-attribute">connectionLimit</span>: <span class="hljs-property">@conf</span>.pool?.limit
        <span class="hljs-attribute">multipleStatements</span>: <span class="hljs-literal">true</span>
      , <span class="hljs-property">@conf</span>.access
      debugPool chalk.grey <span class="hljs-string">"set pool limit to <span class="hljs-subst">#{setup.connectionLimit}</span>"</span> <span class="hljs-keyword">if</span> setup.connectionLimit
      <span class="hljs-property">@pool</span> = mysql.createPool setup
      <span class="hljs-property">@pool</span>.<span class="hljs-literal">on</span> <span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-params">(conn)</span> =&gt;</span>
        conn.name = chalk.grey <span class="hljs-string">"[<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>#<span class="hljs-subst">#{conn._socket._handle.fd}</span>]"</span>
        debugPool <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> open connection"</span>
        conn.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
          debugError <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> uncatched <span class="hljs-subst">#{err}</span> on connection"</span>
      <span class="hljs-property">@pool</span>.<span class="hljs-literal">on</span> <span class="hljs-string">'enqueue'</span>, <span class="hljs-function">=&gt;</span>
        name = chalk.grey <span class="hljs-string">"[<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>]"</span>
        debugPool <span class="hljs-string">"<span class="hljs-subst">#{name}</span> waiting for connection"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>get the connection</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@pool</span>.getConnection (err, conn) =&gt;
      <span class="hljs-keyword">if</span> err
        debugError chalk.grey(<span class="hljs-string">"[<span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>]"</span>) + <span class="hljs-string">" <span class="hljs-subst">#{err}</span> while connecting"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-property">@tries</span> &gt; <span class="hljs-number">2</span> <span class="hljs-comment"># max retries to get a connection</span>
          <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{err.message}</span> while connecting to <span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> database"</span>
        <span class="hljs-keyword">return</span> setTimeout =&gt;
          <span class="hljs-property">@connect</span> cb
        , <span class="hljs-number">1000</span> <span class="hljs-comment"># wait a second fbefore retry</span>
      debugPool <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> acquired connection"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>switch on debugging wih own method</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      conn.config.debug = <span class="hljs-literal">true</span>
      conn._protocol._debugPacket = <span class="hljs-function"><span class="hljs-params">(incoming, packet)</span> -&gt;</span>
        dir = <span class="hljs-keyword">if</span> incoming <span class="hljs-keyword">then</span> <span class="hljs-string">'&lt;--'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'--&gt;'</span>
        msg = util.inspect packet
        <span class="hljs-keyword">switch</span> packet.constructor.name
          <span class="hljs-keyword">when</span> <span class="hljs-string">'ComQueryPacket'</span>
            debugCmd <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{packet.sql}</span>"</span>
          <span class="hljs-keyword">when</span> <span class="hljs-string">'ResultSetHeaderPacket'</span>, <span class="hljs-string">'FieldPacket'</span>, <span class="hljs-string">'EofPacket'</span>
            debugResult <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{packet.constructor.name}</span> <span class="hljs-subst">#{chalk.grey msg}</span>"</span>
          <span class="hljs-keyword">when</span> <span class="hljs-string">'RowDataPacket'</span>
            debugData <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{msg}</span>"</span>
          <span class="hljs-keyword">when</span> <span class="hljs-string">'ComQuitPacket'</span>
            debugPool <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> close connection"</span>
          <span class="hljs-keyword">else</span>
            debugCom <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> <span class="hljs-subst">#{dir}</span> <span class="hljs-subst">#{packet.constructor.name}</span> <span class="hljs-subst">#{chalk.grey msg}</span>"</span>
      conn.release = <span class="hljs-function">-&gt;</span>
        debugPool <span class="hljs-string">"<span class="hljs-subst">#{conn.name}</span> release connection
        (<span class="hljs-subst">#{<span class="hljs-property">@_pool</span>._freeConnections.length+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">#{<span class="hljs-property">@_pool</span>._allConnections.length}</span> free)"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>release code copied from original function</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@_pool</span>? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@_pool</span>._closed
        <span class="hljs-property">@_pool</span>.releaseConnection <span class="hljs-keyword">this</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>return the connection</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      cb <span class="hljs-literal">null</span>, conn

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="shortcut-functions">
  <h2>
    <a href="#shortcut-functions" name="shortcut-functions" class="pilcrow"></a>
Shortcut functions
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="update-insert-or-delete-something-and-return-count-of-changes">
  <h3>
    <a href="#update-insert-or-delete-something-and-return-count-of-changes" name="update-insert-or-delete-something-and-return-count-of-changes" class="pilcrow"></a>
update, insert or delete something and return count of changes
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">exec</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@prepare</span> arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@query</span> conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      cb err, result?.affectedRows, result?.insertId

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-all-data-as-object">
  <h3>
    <a href="#get-all-data-as-object" name="get-all-data-as-object" class="pilcrow"></a>
get all data as object
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">list</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@prepare</span> arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@query</span> conn, sql, data, cb

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-one-record-as-object">
  <h3>
    <a href="#get-one-record-as-object" name="get-one-record-as-object" class="pilcrow"></a>
get one record as object
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">record</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@prepare</span> arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>get only one row</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> sql <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
      sql.limit = <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">unless</span> sql.match <span class="hljs-regexp">/\slimit\s+\d/i</span>
      sql += <span class="hljs-string">" LIMIT 1"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@query</span> conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> result?.length
      cb err, result[<span class="hljs-number">0</span>]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-value-of-one-field">
  <h3>
    <a href="#get-value-of-one-field" name="get-value-of-one-field" class="pilcrow"></a>
get value of one field
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">value</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@prepare</span> arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>get only one row</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> sql <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
      sql.limit = <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">unless</span> sql.match <span class="hljs-regexp">/\slimit\s+\d/i</span>
      sql += <span class="hljs-string">" LIMIT 1"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@query</span> conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> result?.length
      cb err, result[<span class="hljs-number">0</span>][Object.keys(result[<span class="hljs-number">0</span>])[<span class="hljs-number">0</span>]]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-value-of-one-field-1">
  <h3>
    <a href="#get-value-of-one-field-1" name="get-value-of-one-field-1" class="pilcrow"></a>
get value of one field
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">column</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@prepare</span> arguments, <span class="hljs-function"><span class="hljs-params">(err, conn, sql, data, cb)</span> =&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@query</span> conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> result?.length
      cb err, result.map (e) -&gt; e[Object.keys(e)[<span class="hljs-number">0</span>]]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="query-helper">
  <h2>
    <a href="#query-helper" name="query-helper" class="pilcrow"></a>
Query helper
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="prepare-parameter">
  <h3>
    <a href="#prepare-parameter" name="prepare-parameter" class="pilcrow"></a>
prepare parameter
  </h3>
</div>
<p>This will also open a self closing connection if none given.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">prepare</span>: <span class="hljs-function"><span class="hljs-params">(args, cb)</span> -&gt;</span>
    args = Array.prototype.slice.call args
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>defaultd</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    conn = <span class="hljs-literal">null</span>
<span class="hljs-function">    <span class="hljs-title">done</span> = -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> args[<span class="hljs-number">0</span>].constructor.name <span class="hljs-keyword">isnt</span> <span class="hljs-string">'Object'</span>
      conn = args.shift()
    last = args.length - <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> args[last] <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      done = args.pop()
    [sql, data] = args
    <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, conn, sql, data, done <span class="hljs-keyword">if</span> conn
    <span class="hljs-property">@connect</span> (err, conn) -&gt;
      cb err, conn, sql, data, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"MySQL Error: <span class="hljs-subst">#{err.message}</span>"</span> <span class="hljs-keyword">if</span> err
        conn.release()
        done.apply <span class="hljs-keyword">this</span>, arguments

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-the-query-on-the-wrapped-driver">
  <h3>
    <a href="#run-the-query-on-the-wrapped-driver" name="run-the-query-on-the-wrapped-driver" class="pilcrow"></a>
Run the query on the wrapped driver
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">query</span>: <span class="hljs-function"><span class="hljs-params">(conn, sql, data, cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>replace placeholder and interpret object structure</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    sql = <span class="hljs-property">@sql</span> sql, data
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>run the query</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    conn.query sql, data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"MySQL Error: <span class="hljs-subst">#{err.message}</span> in <span class="hljs-subst">#{sql}</span>"</span> <span class="hljs-keyword">if</span> err
      cb <span class="hljs-literal">null</span>, result

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="query-creation">
  <h2>
    <a href="#query-creation" name="query-creation" class="pilcrow"></a>
Query creation
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">escape</span>: SqlString.escape
  <span class="hljs-attribute">escapeId</span>: SqlString.escapeId

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="replace-placeholder-and-object-structure">
  <h3>
    <a href="#replace-placeholder-and-object-structure" name="replace-placeholder-and-object-structure" class="pilcrow"></a>
Replace placeholder and object structure
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">sql</span>: <span class="hljs-function"><span class="hljs-params">(sql, data)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> sql <span class="hljs-keyword">isnt</span> <span class="hljs-string">'string'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>object syntax</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      sql = object2sql sql, <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">if</span> sql.match <span class="hljs-regexp">/\?(?=([^']*'[^']*')*[^']*$)/</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>placeholder</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">return</span> SqlString.format sql, data
    sql

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="exports">
  <h2>
    <a href="#exports" name="exports" class="pilcrow"></a>
Exports
  </h2>
</div>
<p>The mysql class is exported directly.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports = Mysql

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
