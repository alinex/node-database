<!DOCTYPE html>
<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-database/src/index.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#mysql-access">Mysql access</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#setup-and-initialization">Setup and Initialization</a>
      </div>

      <div class="heading h3">
        <a href="#initialization">Initialization</a>
      </div>

      <div class="heading h2">
        <a href="#create-instances">Create Instances</a>
      </div>

      <div class="heading h3">
        <a href="#factory">Factory</a>
      </div>

      <div class="heading h3">
        <a href="#shutdown">Shutdown</a>
      </div>

      <div class="heading h3">
        <a href="#open-ssh-tunnel-if-needed">Open SSH Tunnel if needed</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-database" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="mysql-access">
  <h1>
    <a href="#mysql-access" name="mysql-access" class="pilcrow"></a>
Mysql access
  </h1>
</div>
<p>This package will give you an easy and robust way to access mysql databases.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>https://github.com/Finanzchef24-GmbH/tunnel-ssh/blob/master/index.js -&gt; copy
https://github.com/felixge/node-mysql/ -&gt; use
https://github.com/brianc/node-postgres/tree/master/lib -&gt; use
https://github.com/mapbox/node-sqlite3 -&gt; use
https://github.com/elastic/elasticsearch-js</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>https://www.npmjs.com/package/json-sql</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'database'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
fspath = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include more alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
{object} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>internal helpers</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">schema = <span class="hljs-built_in">require</span> <span class="hljs-string">'./configSchema'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="setup-and-initialization">
  <h2>
    <a href="#setup-and-initialization" name="setup-and-initialization" class="pilcrow"></a>
Setup and Initialization
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialization">
  <h3>
    <a href="#initialization" name="initialization" class="pilcrow"></a>
Initialization
  </h3>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>set the modules config paths and validation schema</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.setup = setup = async.once <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>set module search path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  config.register <span class="hljs-literal">false</span>, fspath.dirname __dirname</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>add schema for module's configuration</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  config.setSchema <span class="hljs-string">'/database'</span>, schema, cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>set the modules config paths, validation schema and initialize the configuration</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.init = init = async.once <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
  debug <span class="hljs-string">"initialize"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>set module search path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  setup (err) -&gt;
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    config.init cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="create-instances">
  <h2>
    <a href="#create-instances" name="create-instances" class="pilcrow"></a>
Create Instances
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="factory">
  <h3>
    <a href="#factory" name="factory" class="pilcrow"></a>
Factory
  </h3>
</div>
<p>Get an instance for the name. This enables the system to use the same
Config instance anywhere.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">instances = {}
exports.instance = instance = <span class="hljs-function"><span class="hljs-params">(name, cb)</span> -&gt;</span>
  init (err) -&gt;
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>start initializing, if not done</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">unless</span> instances[name]?
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Could not initialize database class without alias."</span> <span class="hljs-keyword">unless</span> name
      debug <span class="hljs-string">"create <span class="hljs-subst">#{name}</span> connection"</span>
      conf = config.get <span class="hljs-string">"/database/<span class="hljs-subst">#{name}</span>"</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"No database for name '<span class="hljs-subst">#{name}</span>' defined"</span> <span class="hljs-keyword">unless</span> conf?</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>open tunnel</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">return</span> tunnel conf, <span class="hljs-function"><span class="hljs-params">(err, conf)</span> -&gt;</span>
        debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{conf.server.type}</span>://<span class="hljs-subst">#{conf.server.host}</span>:<span class="hljs-subst">#{conf.server.port}</span>/\
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>{conf.server.database} as #{conf.server.user}&quot;
load driver</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">try</span>
          Driver = <span class="hljs-built_in">require</span> <span class="hljs-string">"./driver/<span class="hljs-subst">#{conf.server.type}</span>"</span>
        <span class="hljs-keyword">catch</span> error
          <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Could not find driver for <span class="hljs-subst">#{conf.server.type}</span> database:
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>{error.message}&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        instances[name] = <span class="hljs-keyword">new</span> Driver name, conf
        cb <span class="hljs-literal">null</span>, instances[name]
    cb <span class="hljs-literal">null</span>, instances[name]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>for fn in ['exec', 'list', 'record', 'column', 'value']
exports[fn] = (name, query, data, cb) -&gt; call fn, name, query, data, cb</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.exec = <span class="hljs-function"><span class="hljs-params">(name, query, data, cb)</span> -&gt;</span> call <span class="hljs-string">'exec'</span>, name, query, data, cb
exports.list = <span class="hljs-function"><span class="hljs-params">(name, query, data, cb)</span> -&gt;</span> call <span class="hljs-string">'list'</span>, name, query, data, cb
exports.record = <span class="hljs-function"><span class="hljs-params">(name, query, data, cb)</span> -&gt;</span> call <span class="hljs-string">'record'</span>, name, query, data, cb
exports.column = <span class="hljs-function"><span class="hljs-params">(name, query, data, cb)</span> -&gt;</span> call <span class="hljs-string">'column'</span>, name, query, data, cb
exports.value = <span class="hljs-function"><span class="hljs-params">(name, query, data, cb)</span> -&gt;</span> call <span class="hljs-string">'value'</span>, name, query, data, cb
<span class="hljs-function">
<span class="hljs-title">call</span> = <span class="hljs-params">(fn, name, query, data, cb)</span> -&gt;</span>
  <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> cb <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    cb = data
    data = <span class="hljs-literal">null</span>
  instance name, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    <span class="hljs-keyword">unless</span> db[fn]?
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The <span class="hljs-subst">#{db.constructor.name}</span> driver didn't support the <span class="hljs-subst">#{fn}</span>() method."</span>
    db[fn] query, data, cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="shutdown">
  <h3>
    <a href="#shutdown" name="shutdown" class="pilcrow"></a>
Shutdown
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.close = <span class="hljs-function"><span class="hljs-params">(cb = -&gt; )</span> -&gt;</span>
  debug <span class="hljs-string">"Close all database connections..."</span>
  async.each Object.keys(instances), <span class="hljs-function"><span class="hljs-params">(name, cb)</span> -&gt;</span>
    instances[name].close cb
  , cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="open-ssh-tunnel-if-needed">
  <h3>
    <a href="#open-ssh-tunnel-if-needed" name="open-ssh-tunnel-if-needed" class="pilcrow"></a>
Open SSH Tunnel if needed
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">tunnel</span> = <span class="hljs-params">(conf, cb)</span> -&gt;</span>
  conf.access = conf.server
  <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, conf <span class="hljs-keyword">unless</span> conf.ssh</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>load ssh modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  sshtunnel = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-sshtunnel'</span>
  sshtunnel
    <span class="hljs-attribute">ssh</span>: conf.ssh
    <span class="hljs-attribute">tunnel</span>:
      <span class="hljs-attribute">host</span>: conf.server.host
      <span class="hljs-attribute">port</span>: conf.server.port
  , <span class="hljs-function"><span class="hljs-params">(err, tunnel)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    conf.access = object.extend {}, conf.server, tunnel.setup
    cb <span class="hljs-literal">null</span>, conf</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
