<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="doc-style.css" />
  <script src="doc-filelist.js"></script>
  <script>
    var relativeDir = "";
    var thisFile = "README.md";
    var defaultSidebar = true;
  </script>
  <script src="doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#package-alinex-database">Package: alinex-database</a>
      </div>

      <div class="heading h2">
        <a href="#install">Install</a>
      </div>

      <div class="heading h2">
        <a href="#usage">Usage</a>
      </div>

      <div class="heading h3">
        <a href="#only-connection-handling">Only connection handling</a>
      </div>

      <div class="heading h3">
        <a href="#easy-access">Easy Access</a>
      </div>

      <div class="heading h3">
        <a href="#streaming">Streaming</a>
      </div>

      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>

      <div class="heading h2">
        <a href="#databases">Databases</a>
      </div>

      <div class="heading h3">
        <a href="#mysql">MySQL</a>
      </div>

      <div class="heading h3">
        <a href="#postgresql">PostgreSQL</a>
      </div>

      <div class="heading h2">
        <a href="#placeholder-syntax">Placeholder Syntax</a>
      </div>

      <div class="heading h2">
        <a href="#object-to-query-language">Object to Query Language</a>
      </div>

      <div class="heading h3">
        <a href="#general-notation">General Notation</a>
      </div>

      <div class="heading h3">
        <a href="#relational-databases">Relational Databases</a>
      </div>

      <div class="heading h4">
        <a href="#select">SELECT</a>
      </div>

      <div class="heading h4">
        <a href="#distinct">DISTINCT</a>
      </div>

      <div class="heading h4">
        <a href="#from">FROM</a>
      </div>

      <div class="heading h4">
        <a href="#where">WHERE</a>
      </div>

      <div class="heading h4">
        <a href="#functions">Functions</a>
      </div>

      <div class="heading h2">
        <a href="#license">License</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-database" title="Fork me on GitHub"></a>
    <div class="docs markdown"><div class="pilwrap" id="package-alinex-database">
  <h1>
    <a href="#package-alinex-database" name="package-alinex-database" class="pilcrow"></a>
Package: alinex-database
  </h1>
</div>
<p><a href="https://travis-ci.org/alinex/node-database"><img src="https://travis-ci.org/alinex/node-database.svg?branch=master" alt="Build Status"></a>
<a href="https://coveralls.io/r/alinex/node-database?branch=master"><img src="https://coveralls.io/repos/alinex/node-database/badge.png?branch=master" alt="Coverage Status"></a>
<a href="https://gemnasium.com/alinex/node-database"><img src="https://gemnasium.com/alinex/node-database.png" alt="Dependency Status"></a></p>
<p>The database module allows connections to different databases easy configurable
and usable with query language builder.</p>
<p>The main features are:</p>
<ul>
<li>different rdbms and other databases</li>
<li>pooling and cluster support</li>
<li>easy access functions</li>
<li>connections through automatic ssh tunnels</li>
<li>object to query language bridge</li>
</ul>
<blockquote>
<p>It is one of the modules of the <a href="http://alinex.github.io/code.html">Alinex Universe</a>
following the code standards defined in the <a href="http://alinex.github.io/develop">General Docs</a>.</p>
</blockquote>
<div class="pilwrap" id="install">
  <h2>
    <a href="#install" name="install" class="pilcrow"></a>
Install
  </h2>
</div>
<p><a href="https://www.npmjs.com/package/alinex-database"><img src="https://nodei.co/npm/alinex-database.png?downloads=true&amp;downloadRank=true&amp;stars=true" alt="NPM">
<img src="https://nodei.co/npm-dl/alinex-database.png?months=9&amp;height=3" alt="Downloads">
</a></p>
<p>The easiest way is to let npm add the module directly to your modules
(from within you node modules directory):</p>
<pre><code class="sh">npm install alinex-config - -save
</code></pre>
<p>And update it to the latest version later:</p>
<pre><code class="sh">npm update alinex-config --save
</code></pre>
<p>Always have a look at the latest <a href="Changelog.md.html">changes</a>.</p>
<div class="pilwrap" id="usage">
  <h2>
    <a href="#usage" name="usage" class="pilcrow"></a>
Usage
  </h2>
</div>
<p>You can use different level of abstraction as you like.</p>
<div class="pilwrap" id="only-connection-handling">
  <h3>
    <a href="#only-connection-handling" name="only-connection-handling" class="pilcrow"></a>
Only connection handling
  </h3>
</div>
<p>The following example shows a complete and simple query transaction using
a mysql database:</p>
<pre><code class="coffee"><span class="hljs-comment"># load the module</span>
database = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-database'</span>

<span class="hljs-comment"># get an instance</span>
database.instance <span class="hljs-string">'test-mysql'</span>, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
  <span class="hljs-keyword">throw</span> err <span class="hljs-keyword">if</span> err
  <span class="hljs-comment"># get a new connection from the pool</span>
  db.connect (err, conn) -&gt;
    <span class="hljs-comment"># query some values</span>
    conn.query <span class="hljs-string">'SELECT 2 + 2 AS solution'</span>, <span class="hljs-function"><span class="hljs-params">(err, rows, fields)</span> -&gt;</span>
      <span class="hljs-keyword">throw</span> err <span class="hljs-keyword">if</span> err
      <span class="hljs-comment"># do something with the results</span>
      <span class="hljs-built_in">console</span>.log <span class="hljs-string">'The database calculated 2+2 ='</span>, rows[<span class="hljs-number">0</span>].solution
      <span class="hljs-comment"># give connection back</span>
      conn.release()
      <span class="hljs-comment"># close database</span>
      db.close (err) -&gt;
</code></pre>
<p>The configuration for the connection is done in the <code>database</code> section of the
configuration used via <a href="http://alinex.github.io/node-config">Config</a>.</p>
<div class="pilwrap" id="easy-access">
  <h3>
    <a href="#easy-access" name="easy-access" class="pilcrow"></a>
Easy Access
  </h3>
</div>
<p>Instead of using the native <code>conn...</code> directly you may use the higher methods:</p>
<ul>
<li><code>list()</code> - get an array of record objects</li>
<li><code>record()</code> - get one record as object</li>
<li><code>value()</code> - get the value of the first field</li>
<li><code>column()</code> - get an array of values from the first column</li>
<li><code>exec()</code> - update/insert or other execution statements</li>
</ul>
<p>This may be called in three ways:</p>
<ol>
<li>call them on the database module:
Therefore give the database alias as first parameter like:
<code>database.exec 'my-db', 'SELECT...', [data], (err) -&gt; ...</code></li>
<li>call them on the database instance:
So you can remove the first parameter:
<code>db.exec 'SELECT...', [data], (err) -&gt; ...</code></li>
<li>also give a connection instance as first argument:
This way you may run multiple commands on the same connection:
<code>db.exec conn, 'SELECT...', [data], (err) -&gt; ...</code></li>
</ol>
<p>If you run multiple queries on the same database better use solution (2) and
if you have statements which use common variables or transactions you need to
use (3).</p>
<p><strong>Example:</strong></p>
<p>Call with method (1) using the database module:</p>
<pre><code class="coffee">database.record <span class="hljs-string">'my-database'</span>, <span class="hljs-string">'SELECT * FROM user WHERE ID=5'</span>, <span class="hljs-function"><span class="hljs-params">(err, record)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</code></pre>
<p>Call with method (2) using the db instance:</p>
<pre><code class="coffee">database.instance <span class="hljs-string">'my-database'</span>, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
  db.record <span class="hljs-string">'SELECT * FROM user WHERE ID=5'</span>, <span class="hljs-function"><span class="hljs-params">(err, record)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</code></pre>
<p>Call with method (3) on connection:</p>
<pre><code class="coffee">database.instance <span class="hljs-string">'my-database'</span>, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
  <span class="hljs-comment"># get a new connection from the pool</span>
  db.connect (err, conn) -&gt;
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    db.record conn, <span class="hljs-string">'SELECT * FROM user WHERE ID=5'</span>, <span class="hljs-function"><span class="hljs-params">(err, record)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-comment"># if you acquire a connection yourself don't forget to release it</span>
      conn.release()

</code></pre>
<p><strong>Additional Possibilities:</strong></p>
<p>With this methods you can also use one of the higher SQL Builders:</p>
<ul>
<li>using placeholder for variables</li>
<li>definition as object structure</li>
</ul>
<p>They make it easier readable and helps preventing problems. See the description
below.</p>
<div class="pilwrap" id="streaming">
  <h3>
    <a href="#streaming" name="streaming" class="pilcrow"></a>
Streaming
  </h3>
</div>
<p>For large data sets, please use the native streaming possibilities till we can
implement some common behavior here.</p>
<div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow"></a>
Configuration
  </h2>
</div>
<pre><code class="yaml"><span class="hljs-comment"># Database setup</span>
<span class="hljs-comment"># =================================================</span>

<span class="hljs-comment"># Specific database</span>
<span class="hljs-comment"># -------------------------------------------------</span>
&lt;name&gt;:

  <span class="hljs-comment"># optional you may use a ssh tunnel to connect through</span>
<span class="hljs-attr">  ssh:</span>

    <span class="hljs-comment"># hostname or ip to connect to</span>
<span class="hljs-attr">    host:</span> localhost
    <span class="hljs-comment"># connection port</span>
<span class="hljs-attr">    port:</span>  ssh
    <span class="hljs-comment"># user to login as</span>
<span class="hljs-attr">    username:</span> alex
    <span class="hljs-comment"># (optionally) private key for login</span>
<span class="hljs-attr">    privateKey:</span> &lt;&lt;&lt;file:///home/alex/.ssh/id_rsa&gt;&gt;<span class="hljs-string">&gt;
    # time for sending keepalive packets
</span><span class="hljs-attr">    keepaliveInterval:</span> <span class="hljs-number">1</span>s
    <span class="hljs-comment">#debug: true</span>

  <span class="hljs-comment"># database server</span>
<span class="hljs-attr">  server:</span>

    <span class="hljs-comment"># type of database (mysql, postgresql, sqlite, mongodb, elasticsearch)</span>
<span class="hljs-attr">    type:</span> mysql

    <span class="hljs-comment"># the host and port of the database, if no port given the default for</span>
    <span class="hljs-comment"># this type is used</span>
<span class="hljs-attr">    host:</span> &lt;&lt;&lt;env://MYSQL_HOST | localhost&gt;&gt;<span class="hljs-string">&gt;
    #port: &lt;&lt;&lt;env://MYSQL_PORT | 3306&gt;&gt;&gt;

    # name of the database or catalog
</span><span class="hljs-attr">    database:</span> &lt;&lt;&lt;env://MYSQL_DATABASE | test&gt;&gt;<span class="hljs-string">&gt;

    # authentication on the database server
</span><span class="hljs-attr">    user:</span> &lt;&lt;&lt;env://MYSQL_USER | test&gt;&gt;<span class="hljs-string">&gt;
</span><span class="hljs-attr">    password:</span> &lt;&lt;&lt;env://MYSQL_PASSWORD | &gt;&gt;<span class="hljs-string">&gt;

    # specific database settings
    #charset: UTF8_GENERAL_CI
    #timezone: local

    # timeout settings
    #connectTimeout: 10s

  # specific settings for pooling
</span><span class="hljs-attr">  pool:</span>

    <span class="hljs-comment"># limit the parallel connections</span>
<span class="hljs-attr">    limit:</span> <span class="hljs-number">2</span>
</code></pre>
<div class="pilwrap" id="databases">
  <h2>
    <a href="#databases" name="databases" class="pilcrow"></a>
Databases
  </h2>
</div>
<p>The different supported databases have a lot in common, but differ in some ways.</p>
<p>In general you always can use only the connection handling using <code>db.connect()</code>
to get a connection of the database driver behind. If you want to use this directly
look at the API behind each abstraction layer.</p>
<div class="pilwrap" id="mysql">
  <h3>
    <a href="#mysql" name="mysql" class="pilcrow"></a>
MySQL
  </h3>
</div>
<p>Use the <a href="https://github.com/felixge/node-mysql">Driver API</a> if you want to work
directly on the retrieved connections.</p>
<p>You can also use ? and ?? placeholder syntax from the driver.</p>
<p>Here you need to know that if you use '*' as field specifier the same name may
occur multiple times in the result set, so that they override each over in the
resulting object and the last one will be visible. To prevent this specify this
columns with an alias name.</p>
<div class="pilwrap" id="postgresql">
  <h3>
    <a href="#postgresql" name="postgresql" class="pilcrow"></a>
PostgreSQL
  </h3>
</div>
<p>Use the <a href="https://github.com/brianc/node-postgres">Driver API</a> if you want to work
directly on the retrieved connections.</p>
<p>You can use the native $1... placeholder syntax or the common supported '?' syntax
from the driver.</p>
<div class="pilwrap" id="placeholder-syntax">
  <h2>
    <a href="#placeholder-syntax" name="placeholder-syntax" class="pilcrow"></a>
Placeholder Syntax
  </h2>
</div>
<p>You may write your query like done normal as string but instead inserting the
values and esacaping them you may use <code>?</code> as a placeholder and give your values
in an array. They will be automatically be replaced with their correct escaped value.</p>
<p>Therefore you give the dataset as the second argument:</p>
<pre><code class="coffee">conn.query <span class="hljs-string">'SELECT name FROM address WHERE age &gt; ? and name = ?'</span>,
[<span class="hljs-number">30</span>, <span class="hljs-string">'alf'</span>]
</code></pre>
<p>This will also format the date database specific. And you may also replace with
objects:</p>
<pre><code class="coffee">conn.query <span class="hljs-string">'INSERT INTO address SET ?'</span>,
  name: <span class="hljs-string">'Alf'</span>
  age: <span class="hljs-number">56</span>
</code></pre>
<div class="pilwrap" id="object-to-query-language">
  <h2>
    <a href="#object-to-query-language" name="object-to-query-language" class="pilcrow"></a>
Object to Query Language
  </h2>
</div>
<p>The next possibility is to use a complete object notation instead of a string.</p>
<div class="pilwrap" id="general-notation">
  <h3>
    <a href="#general-notation" name="general-notation" class="pilcrow"></a>
General Notation
  </h3>
</div>
<p>To make the notation clean and prevent misleading situations the values have to
be prefixed with:</p>
<ul>
<li>@... for names like table and fields</li>
<li>$... for functions</li>
<li>? used as value will be a placeholder like before and used with the given dataset</li>
</ul>
<p>All other values are used as is and quoted or converted like needed.</p>
<div class="pilwrap" id="relational-databases">
  <h3>
    <a href="#relational-databases" name="relational-databases" class="pilcrow"></a>
Relational Databases
  </h3>
</div>
<p>Here you define your query like an object. The structure looks much like the
SQL dialect itself to make it easy:</p>
<pre><code class="coffee">  conn.query
    select: <span class="hljs-string">'*'</span>
    from: <span class="hljs-string">'@person'</span>
    where:
      age: <span class="hljs-number">30</span>
      name: <span class="hljs-string">'Alf'</span>
  <span class="hljs-comment"># SQL: SELECT * FROM `person` WHERE `age` = 30 AND `name` = 'Alf'</span>
</code></pre>
<p>The object notation is easier to read and can be created step by step.
Also the object will be validated if run with <code>DEBUG=database*</code> flag.</p>
<p>The following description will explain all the possible keys (uppermost level)
of the object structure you give to create the SQL string.</p>
<div class="pilwrap" id="select">
  <h4>
    <a href="#select" name="select" class="pilcrow"></a>
SELECT
  </h4>
</div>
<p>First you can define a single value defining what you want.</p>
<pre><code class="yaml"><span class="hljs-attr">select:</span> <span class="hljs-string">'@name'</span>       <span class="hljs-comment"># column name</span>
<span class="hljs-attr">select:</span> <span class="hljs-string">'*'</span>           <span class="hljs-comment"># all columns</span>
<span class="hljs-attr">select:</span> <span class="hljs-string">'@person.*'</span>   <span class="hljs-comment"># all columns of table person</span>
</code></pre>
<p>Or give an array with multiple values:</p>
<pre><code class="yaml"><span class="hljs-attr">select:</span> [<span class="hljs-string">'@name'</span>, <span class="hljs-string">'@age'</span>] <span class="hljs-comment"># fields array</span>
</code></pre>
<p>To give each column a specific alias name use an object:</p>
<pre><code class="yaml"><span class="hljs-attr">select:</span>
<span class="hljs-attr">  PersonName:</span> <span class="hljs-string">'@name'</span>
</code></pre>
<p>And at last you may also use functions:</p>
<pre><code class="yaml"><span class="hljs-attr">select:</span>
  $count: <span class="hljs-string">'*'</span>
<span class="hljs-attr">select:</span>
<span class="hljs-attr">  PersonName:</span>
    $count: <span class="hljs-string">'*'</span>
</code></pre>
<div class="pilwrap" id="distinct">
  <h4>
    <a href="#distinct" name="distinct" class="pilcrow"></a>
DISTINCT
  </h4>
</div>
<p>If set the query will only return distinct (different) records:</p>
<pre><code class="yaml"><span class="hljs-attr">distinct:</span> <span class="hljs-literal">true</span>
</code></pre>
<div class="pilwrap" id="from">
  <h4>
    <a href="#from" name="from" class="pilcrow"></a>
FROM
  </h4>
</div>
<p>Give the tables or catalogs to use.</p>
<pre><code class="yaml"><span class="hljs-attr">from:</span> <span class="hljs-string">'@person'</span>
</code></pre>
<p>Or as an array (using a full join):</p>
<pre><code class="yaml"><span class="hljs-attr">from:</span> [<span class="hljs-string">'@person'</span>, <span class="hljs-string">'@address'</span>]
</code></pre>
<p>Also this may be named:</p>
<pre><code class="yaml"><span class="hljs-attr">form:</span>
<span class="hljs-attr">  Person:</span> @person
</code></pre>
<p>And with specific joins:</p>
<pre><code class="yaml"><span class="hljs-attr">from:</span>
<span class="hljs-attr">  Person:</span> @person
<span class="hljs-attr">  Address:</span>
<span class="hljs-attr">    address:</span>
<span class="hljs-attr">      join:</span> <span class="hljs-string">'left'</span>   <span class="hljs-comment"># left, right, outer, inner</span>
<span class="hljs-attr">      on:</span>            <span class="hljs-comment"># join criteria</span>
<span class="hljs-attr">        ID:</span> <span class="hljs-string">'@person.addressID'</span>
<span class="hljs-attr">        age:</span>
          $gt: <span class="hljs-number">5</span>
<span class="hljs-comment"># same defined as array</span>
<span class="hljs-attr">from:</span> [
  <span class="hljs-string">'@person'</span>
,
<span class="hljs-attr">  Address:</span>
<span class="hljs-attr">    address:</span>
<span class="hljs-attr">      join:</span> <span class="hljs-string">'left'</span>   <span class="hljs-comment"># left, right, outer, inner</span>
<span class="hljs-attr">      on:</span>            <span class="hljs-comment"># join criteria</span>
<span class="hljs-attr">        ID:</span> <span class="hljs-string">'@Person.addressID'</span>
<span class="hljs-attr">        age:</span>
          $gt: <span class="hljs-number">5</span>
]
</code></pre>
<div class="pilwrap" id="where">
  <h4>
    <a href="#where" name="where" class="pilcrow"></a>
WHERE
  </h4>
</div>
<p>Constraints can be defined using where. If no operator is given the field is
checked against equality to the given value:</p>
<pre><code class="yaml"><span class="hljs-attr">where:</span>
<span class="hljs-attr">  age:</span> <span class="hljs-number">30</span>
</code></pre>
<p>But you also can give any comparison operator of the ones listed below:</p>
<pre><code class="yaml"><span class="hljs-attr">where:</span>
<span class="hljs-attr">  age:</span>
    $gt: <span class="hljs-number">30</span>
</code></pre>
<div class="pilwrap" id="functions">
  <h4>
    <a href="#functions" name="functions" class="pilcrow"></a>
Functions
  </h4>
</div>
<p><strong>Comparison</strong></p>
<ul>
<li>eq - equal</li>
<li>ne - not equal</li>
<li>gt - greater than</li>
<li>lt - lower than</li>
<li>ge - greater or equal</li>
<li>le - lower or equal</li>
<li>like - like given pattern</li>
<li>in - in list of values</li>
<li>between - the given 'min' and 'max' values</li>
</ul>
<p><strong>Group functions</strong></p>
<ul>
<li>count - number of entries</li>
</ul>
<p><strong>Special</strong></p>
<ul>
<li>value - used if value is needed on the left side of operator</li>
</ul>
<div class="pilwrap" id="license">
  <h2>
    <a href="#license" name="license" class="pilcrow"></a>
License
  </h2>
</div>
<p>Copyright 2015-2016 Alexander Schilling</p>
<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<blockquote>
<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
</blockquote>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</div>
  </div>
</body>
</html>
